# Grok 图片/视频生成插件（Provider 版）

> 基于 AstrBot 提供商体系（`select_provider`）的 Grok 多媒体插件。  
> 支持文生图、图生图、文生视频、图生视频，自动下载并发送结果。

---

## 功能特性

- 🎬 **视频生成**：支持文生视频 / 图生视频
- 🎨 **图像生成**：支持文生图 / 图生图
- 🔁 **批量任务**：支持 `视频N / 画图N`
- 🧠 **预设联动**：可对接全局预设 [astrbot_plugin_preset_hub](https://github.com/Menkelo/astrbot_plugin_preset_hub)
- 🖼️ **智能取图**：
  - 当前消息图片
  - 引用消息图片
  - `@用户`头像作为参考图
- ✂️ **图片预处理**：视频场景可按常见比例做裁剪优化（依赖 Pillow）
- 🧹 **自动清理**：发送后自动删除本地缓存文件（默认）

---

## 安装与依赖

- Python 依赖：
  - `httpx`
  - `aiofiles`
  - （可选）`Pillow`：用于图片裁剪/压缩优化

```bash
pip install httpx aiofiles Pillow
```

---

## 使用方法

## 1) 视频生成（文生视频 / 图生视频）

- `/视频 提示词`
- `/视频3 提示词`（连续生成 3 次）

说明：

- 有参考图：走图生视频
- 无参考图：走文生视频
- 文生视频可在提示词中写比例（`aspect_ratio`），例如 `1:1`、`16:9`、`9:16`

示例：

- `/视频 一只猫在跑步`
- `/视频 鹅在游泳 1:1`
- `/视频 夜晚城市延时镜头 16:9`
- `/视频3 海边日落 9:16`

---

## 2) 图片生成（文生图 / 图生图）

- `/画图 提示词`
- `/画图4 提示词`（连续生成 4 次）

说明：

- 无参考图：文生图，支持比例或尺寸控制  
- 有参考图：图生图（按原图比例，不支持改比例）

示例：

- `/画图 一只白猫 1:1`
- `/画图 未来城市 16:9`
- `/画图 赛博朋克少女 1024x1792`
- `/画图 把这张图改成水彩风 +图片`

---

## 比例与尺寸规则

### 文生图

支持比例映射：

- `1:1` -> `1024x1024`
- `2:3` -> `1024x1792`
- `16:9` -> `1280x720`
- `3:2` -> `1792x1024`
- `9:16` -> `720x1280`

也支持直接写尺寸：

- `1024x1024 / 1024x1792 / 1280x720 / 1792x1024 / 720x1280`

默认尺寸：

- 未指定时默认 `1024x1792`（2:3 近似竖图）

### 图生图

- 固定按原图比例处理
- 提示词里的比例/尺寸标记不会用于改图尺寸

### 文生视频

- 支持比例参数（`aspect_ratio`）  
- 可用写法如：`1:1`、`16:9`、`9:16`

---

## 预设联动说明

- 当前仅在**图生图（edit）**链路应用预设
- `@某人`、比例/尺寸标记不计入“额外提示词”
- 因此状态文案不会因为纯 `@` 或纯比例而显示“已衔接额外提示词”

---

## 提示词提取说明

插件支持命令后完整文本提取，包括：

- 空格后的全部内容
- 换行后的内容（多行提示词）
- 紧贴写法（如 `猫咪1:1`）

例如：

```text
/画图 一个赛博朋克少女
蓝色霓虹灯
电影感构图 9:16
```

---

## 配置方式（Provider-only）

本插件为 Provider-only 模式：  
❌ 不再手填 `server_url` / `api_key` / `model_id`  
✅ 直接在插件配置中选择 Provider

### `_conf_schema.json` 字段

- `video_provider_id`：视频模型提供商（select_provider）
- `image_gen_provider_id`：文生图模型提供商（select_provider）
- `image_edit_provider_id`：图生图模型提供商（select_provider）

---

## 提供商要求

插件会从 AstrBot Provider 中读取：

- `base_url`（或 `api_base` / `api_base_url` 等）
- `api_key`（或 `key` / `keys` / `token` 等）
- `model`（或从 `provider_id` 的 `provider/model` 自动提取）

缺失时会报错：

- `❌ 提供商缺少 base_url: xxx/yyy`
- `❌ 提供商缺少 api_key: xxx/yyy`
- `❌ 提供商缺少 model: xxx/yyy`

---

## 与 Grok2API 的关系

可直接使用 Grok2API 作为后端，只是配置入口在 AstrBot Provider。  
把 Grok2API 地址和密钥配置到 Provider 后，在插件中选择对应 provider_id 即可。

参考项目：

- https://github.com/chenyme/grok2api
- https://github.com/Tomiya233/grok2api
- https://github.com/XeanYu/grok2api-rs

---

## 技术实现摘要

- Chat 接口：`/v1/chat/completions`
  - 用于视频生成（文生/图生）
- Image 接口：`/v1/images/generations`
  - 用于文生图
- Image Edit 接口：`/v1/images/edits`
  - 用于图生图（按原图比例）
- 自动重试：
  - 针对 429 / 部分 5xx 做有限重试
- 发送失败兜底：
  - 图片发送异常时尝试 Base64 补发
- 临时文件管理：
  - 默认发送后清理，降低磁盘占用

---

## 常见问题（FAQ）

### Q1：报错 `提供商缺少 base_url`
A：你选中的 provider 没有对插件暴露直连地址。  
请检查 provider 配置是否包含 `api_base/base_url`，或更换可直连 OpenAI 兼容接口的 provider。

### Q2：报错 `提供商缺少 api_key`
A：请在 provider 中补全密钥字段（`key/api_key/token`）。

### Q3：命令后半段提示词丢失
A：已修复。当前版本支持空格与换行后的完整内容，并兼容比例紧贴写法（如 `1:1`）。

### Q4：视频比例不生效怎么办？
A：先看日志是否出现 `aspect_ratio=1:1`。  
若插件日志已透传但结果仍无变化，通常是后端模型未实现该参数，请检查后端版本与实现。

### Q5：图生图为什么不按 `1:1` 生成？
A：图生图当前固定按原图比例处理，提示词中的比例仅会被清理，不用于改尺寸。

---

## 注意事项

1. 视频任务耗时较长，请耐心等待。  
2. 网络需稳定（生成后还需下载媒体文件）。  
3. 默认不保留历史生成文件（自动清理）。  
4. 请遵守所在平台与法律法规。
